define(["jquery","Magento_Checkout/js/view/payment/default","Magento_Checkout/js/action/place-order","Magento_Checkout/js/model/payment/additional-validators","Magento_Checkout/js/model/quote","Magento_Checkout/js/model/full-screen-loader","Magento_Checkout/js/action/redirect-on-success"],(function(e,t,a,o,r,n,s){"use strict";return t.extend({defaults:{template:"Vella_Pay/payment/vellapay",customObserverName:null},redirectAfterPlaceOrder:!1,initialize:function(){this._super();var e=document.createElement("div");e.id="vew-widget",document.body.appendChild(e);window.checkoutConfig.payment.vellapay.api_url;var t=document.createElement("script");return t.setAttribute("src","https://checkout.vella.finance/widget/sdk.js"),t.setAttribute("type","module"),t.setAttribute("id","vella-checkout-module"),document.head.appendChild(t),this},getCode:function(){return"vellapay"},getData:function(){return{method:this.item.method,additional_data:{}}},getGuestEmail:function(){return r.guestEmail},isActive:function(){return!0},afterPlaceOrder:function(){var t=window.checkoutConfig,a=r.billingAddress(),o=t.payment.vellapay;if(t.isCustomerLoggedIn){var n=t.customerData;a.email=n.email,a.name=n.firstname+" "+n.lastname}else{JSON.parse(localStorage.getItem("mage-cache-storage"))["checkout-data"];a.email=r.guestEmail,a.name=a.firstname+" "+a.lastname}var i=t.quoteItemData[0].quote_id,c=this;let l,d;c.isPlaceOrderActionAllowed(!1),l="1"===o.test_mode?o.test_key:o.live_key;var u="NGNT";u="NGN"===t.totalsData.quote_currency_code?"NGNT":"USD"===t.totalsData.quote_currency_code?"USDT":t.totalsData.quote_currency_code;const m={email:a.email,name:a.name,amount:r.totals().grand_total,currency:u,merchant_id:o.merchant_id,reference:i+"_VEMAGE"+Math.floor(1e9*Math.random()+1),source:"magento",meta:[{metaname:"QuoteId",metavalue:i},{metaname:"Address",metavalue:a.street[0]+", "+a.street[1]},{metaname:"Postal Code",metavalue:a.postcode},{metaname:"City",metavalue:a.city+", "+a.countryId}]},g=VellaCheckoutSDK.init(l,m);g.onSuccess((t=>{if("Successful"==t.data.status||"Completed"==t.data.status){d="1"===o.test_mode?"https://sandbox.vella.finance/api/v1/checkout/transaction/"+t.data.reference+"/verify":"https://api.vella.finance/api/v1/checkout/transaction/"+t.data.reference+"/verify";var a={url:d,method:"GET",timeout:0,headers:{Authorization:"Bearer "+l}};setTimeout((()=>{e.ajax(a).done((function(e){var t=e.data.status,a=e.data.amount;e.data.currency;("Successful"==t||"Completed"==t)&&a>=r.totals().grand_total?s.execute():(c.isPlaceOrderActionAllowed(!0),c.messageContainer.addErrorMessage({message:"Error, please try again"}))}))}),1e3)}else c.isPlaceOrderActionAllowed(!0),c.messageContainer.addErrorMessage({message:"Error, please try again"})})),g.onError((e=>{c.messageContainer.addErrorMessage({message:"Error, Something went wrong"})})),g.onClose((()=>{}))}})}));