define(["jquery","Magento_Checkout/js/model/quote","Magento_Checkout/js/model/url-builder","Magento_Customer/js/customer-data","Magento_Checkout/js/view/payment/default","Magento_Checkout/js/model/payment/additional-validators","mage/storage","mage/url","Magento_Checkout/js/model/full-screen-loader","Magento_Checkout/js/action/place-order","Magento_Customer/js/model/customer"],(function(e,t,a,o,n,r,s,i,c,d,u,l){"use strict";return n.extend({config:window.checkoutConfig,defaults:{template:"Vella_Pay/payment/vellapay",customObserverName:null,paymentMethodNonce:null},redirectAfterPlaceOrder:!1,initialize:function(){this._super();var e=document.createElement("div");e.id="vew-widget",document.body.appendChild(e);window.checkoutConfig.payment.vellapay.api_url;var a=document.createElement("script");return a.setAttribute("src","https://checkout.vella.finance/widget/sdk.js"),a.setAttribute("type","module"),a.setAttribute("id","vella-checkout-module"),document.head.appendChild(a),setTimeout((()=>{t.getQuoteId()}),1e3),this},getCode:function(){return"vellapay"},getCustomerInfo:function(){var e,t,a,o;if(this.config.isCustomerLoggedIn){var n=this.config.customerData;t=n.email,o=n.firstname,a=n.lastname,e=n.firstname+" "+n.lastname}else{var r=JSON.parse(localStorage.getItem("mage-cache-storage"))["checkout-data"];t=r.validatedEmailValue,e=(o=r.shippingAddressFromData.firstname)+" "+(a=r.shippingAddressFromData.lastname)}return{email:t,firstName:o,lastName:a,customerName:e}},getData:function(){return{method:this.getCode(),additional_data:{payment_method_nonce:this.paymentMethodNonce}}},getGrandTotal:function(){if(totals.totals())return parseFloat(totals.totals().grand_total)},getOrderTotal:function(){return window.checkoutConfig.quoteData.base_grand_total},isActive:function(){return!0},getQuoteCurrency:function(){return this.config.quoteData.quote_currency_code},setPaymentMethodNonce:function(e){this.paymentMethodNonce=e},beforePlaceOrder:function(e){this.setPaymentMethodNonce(e.nonce)},makePayment:function(t,a){c.startLoader();var o=window.checkoutConfig;document.getElementById("vellapaybutton").disabled=!0,e("#vellapaybutton").text("processing...");var n=o.payment.vellapay,r=o.quoteItemData[0].quote_id,s=this;let i,d;i="1"===n.test_mode||1===n.test_mode?n.test_key:n.live_key;var u=this.getQuoteCurrency();"USD"===u&&(u="USDT");var l=Math.ceil(this.getOrderTotal());const m={email:this.getCustomerInfo().email,name:this.getCustomerInfo().customerName,amount:l,currency:u,merchant_id:n.merchant_id,reference:r+"_VEMAGE"+Math.floor(1e9*Math.random()+1),source:"magento",meta_data:[{metaname:"QuoteId",metavalue:r}]},g=VellaCheckoutSDK.init(i,m);g.onSuccess((t=>{d="1"===n.test_mode||1===n.test_mode?"https://sandbox.vella.finance/api/v1/checkout/transaction/"+t.data.reference+"/verify":"https://api.vella.finance/api/v1/checkout/transaction/"+t.data.reference+"/verify";var a={url:d,method:"GET",timeout:0,headers:{Authorization:"Bearer "+i}};setTimeout((()=>{e.ajax(a).done((function(t){var a=t.data&&t.data.status,o=t.data&&t.data.amount;if(!a||!o)return s.messageContainer.addErrorMessage({message:"Missing payment details"});document.getElementById("vellapaybutton").disabled=!1,e("#vellapaybutton").text("Pay Now"),"successful"!==a.toLowerCase()&&"completed"!==a.toLowerCase()?s.resetPaymentError("awaiting payment confirmation"):s.placeOrder()})).fail((function(){s.resetPaymentError("Unable to retrieve payment details")}))}),1e3)})),g.onError((e=>{s.resetPaymentError("Error, Something went wrong with payment")})),g.onClose((()=>{s.resetPaymentError("payment widget closed")}))},afterPlaceOrder:function(){window.location.href=window.BASE_URL+"checkout/onepage/success"},resetPaymentError:function(t){c.stopLoader(),this.messageContainer.addErrorMessage({message:t}),e("#vellapaybutton").text("Pay Now"),document.getElementById("vellapaybutton").disabled=!1}})}));