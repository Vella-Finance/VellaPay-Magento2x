define(["jquery","Magento_Checkout/js/model/quote","Magento_Checkout/js/model/url-builder","Magento_Customer/js/customer-data","Magento_Checkout/js/view/payment/default","Magento_Checkout/js/model/payment/additional-validators","mage/storage","mage/url","Magento_Checkout/js/model/full-screen-loader","Magento_Checkout/js/action/place-order","Magento_Customer/js/model/customer"],(function(e,t,a,o,n,r,s,i,c,d,u,l){"use strict";return n.extend({config:window.checkoutConfig,defaults:{template:"Vella_Pay/payment/vellapay",customObserverName:null,paymentMethodNonce:null},redirectAfterPlaceOrder:!1,initialize:function(){this._super();var e=document.createElement("div");e.id="vew-widget",document.body.appendChild(e);window.checkoutConfig.payment.vellapay.api_url;var a=document.createElement("script");return a.setAttribute("src","https://checkout.vella.finance/widget/sdk.js"),a.setAttribute("type","module"),a.setAttribute("id","vella-checkout-module"),document.head.appendChild(a),setTimeout((()=>{t.getQuoteId()}),1e3),this},getCode:function(){return"vellapay"},getCustomerInfo:function(){var e,t,a,o;if(this.config.isCustomerLoggedIn){var n=this.config.customerData;t=n.email,o=n.firstname,a=n.lastname,e=n.firstname+" "+n.lastname}else{var r=JSON.parse(localStorage.getItem("mage-cache-storage"))["checkout-data"];t=r.validatedEmailValue,e=(o=r.shippingAddressFromData.firstname)+" "+(a=r.shippingAddressFromData.lastname)}return{email:t,firstName:o,lastName:a,customerName:e}},getData:function(){return{method:this.getCode(),additional_data:{payment_method_nonce:this.paymentMethodNonce}}},getGrandTotal:function(){if(totals.totals())return parseFloat(totals.totals().grand_total)},getOrderTotal:function(){return window.checkoutConfig.quoteData.base_grand_total},isActive:function(){return!0},getQuoteCurrency:function(){return this.config.quoteData.quote_currency_code},setPaymentMethodNonce:function(e){this.paymentMethodNonce=e},beforePlaceOrder:function(e){this.setPaymentMethodNonce(e.nonce)},makePayment:function(a,o){c.startLoader();var n=window.checkoutConfig;document.getElementById("vellapaybutton").disabled=!0,e("#vellapaybutton").text("processing...");var r=n.payment.vellapay,s=n.quoteItemData[0].quote_id,i=this;let d,u;d="1"===r.test_mode||1===r.test_mode?r.test_key:r.live_key;var l=this.getQuoteCurrency();"USD"===l&&(l="USDT");var m=Math.ceil(t.totals().grand_total);const g={email:this.getCustomerInfo().email,name:this.getCustomerInfo().customerName,amount:m,currency:l,merchant_id:r.merchant_id,reference:s+"_VEMAGE"+Math.floor(1e9*Math.random()+1),source:"magento",meta_data:[{metaname:"QuoteId",metavalue:s}]},h=VellaCheckoutSDK.init(d,g);h.onSuccess((t=>{u="1"===r.test_mode||1===r.test_mode?"https://sandbox.vella.finance/api/v1/checkout/transaction/"+t.data.reference+"/verify":"https://api.vella.finance/api/v1/checkout/transaction/"+t.data.reference+"/verify";var a={url:u,method:"GET",timeout:0,headers:{Authorization:"Bearer "+d}};setTimeout((()=>{e.ajax(a).done((function(t){var a=t.data&&t.data.status,o=t.data&&t.data.amount;if(!a||!o)return i.messageContainer.addErrorMessage({message:"Missing payment details"});document.getElementById("vellapaybutton").disabled=!1,e("#vellapaybutton").text("Pay Now"),"successful"!==a.toLowerCase()&&"completed"!==a.toLowerCase()?i.resetPaymentError("awaiting payment confirmation"):window.location.href=window.BASE_URL+"checkout/onepage/success"})).fail((function(){i.resetPaymentError("Unable to retrieve payment details")}))}),1e3)})),h.onError((e=>{i.resetPaymentError("Error, Something went wrong with payment")})),h.onClose((()=>{i.resetPaymentError("payment widget closed")}))},afterPlaceOrder:function(){this.makePayment()},resetPaymentError:function(t){c.stopLoader(),this.messageContainer.addErrorMessage({message:t}),e("#vellapaybutton").text("Pay Now"),document.getElementById("vellapaybutton").disabled=!1}})}));