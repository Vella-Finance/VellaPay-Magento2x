define(["jquery","Magento_Checkout/js/view/payment/default","Magento_Checkout/js/model/payment/additional-validators","Magento_Checkout/js/model/quote","Magento_Customer/js/model/customer","Magento_Customer/js/customer-data","Magento_Checkout/js/action/place-order","Magento_Checkout/js/model/full-screen-loader","Magento_Checkout/js/action/redirect-on-success"],(function(e,t,a,o,n,r){"use strict";return t.extend({config:window.checkoutConfig,defaults:{template:"Vella_Pay/payment/vellapay",customObserverName:null,paymentMethodNonce:null},redirectAfterPlaceOrder:!0,initialize:function(){this._super();var e=document.createElement("div");e.id="vew-widget",document.body.appendChild(e);window.checkoutConfig.payment.vellapay.api_url;var t=document.createElement("script");return t.setAttribute("src","https://checkout.vella.finance/widget/sdk.js"),t.setAttribute("type","module"),t.setAttribute("id","vella-checkout-module"),document.head.appendChild(t),this},getCode:function(){return"vellapay"},getCustomerInfo:function(){var e,t,a,o;if(this.config.isCustomerLoggedIn){var n=this.config.customerData;t=n.email,o=n.firstname,a=n.lastname,e=n.firstname+" "+n.lastname}else{var r=JSON.parse(localStorage.getItem("mage-cache-storage"))["checkout-data"];t=r.validatedEmailValue,e=(o=r.shippingAddressFromData.firstname)+" "+(a=r.shippingAddressFromData.lastname)}return{email:t,firstName:o,lastName:a,customerName:e}},getData:function(){return{method:this.item.method,additional_data:{}}},getOrderTotal:function(){return this.config.totalsData.grand_total},isActive:function(){return!0},getQuoteCurrency:function(){return this.config.quoteData.quote_currency_code},setPaymentMethodNonce:function(e){this.paymentMethodNonce=e},beforePlaceOrder:function(e){this.setPaymentMethodNonce(e.nonce)},makePayment:function(){var t=window.checkoutConfig;document.getElementById("vellapaybutton").disabled=!0,e("#vellapaybutton").text("processing...");var a=t.payment.vellapay,o=t.quoteItemData[0].quote_id,n=this;let r,i;n.isPlaceOrderActionAllowed(!1),r="1"===a.test_mode||1===a.test_mode?a.test_key:a.live_key;var s=this.getQuoteCurrency();"USD"===s&&(s="USDT");var c=parseFloat(this.getOrderTotal()).toFixed(2);const d={email:this.getCustomerInfo().email,name:this.getCustomerInfo().customerName,amount:c,currency:s,merchant_id:a.merchant_id,reference:o+"_VEMAGE"+Math.floor(1e9*Math.random()+1),source:"magento",meta_data:[{metaname:"QuoteId",metavalue:o}]},l=VellaCheckoutSDK.init(r,d);l.onSuccess((t=>{i="1"===a.test_mode||1===a.test_mode?"https://sandbox.vella.finance/api/v1/checkout/transaction/"+t.data.reference+"/verify":"https://api.vella.finance/api/v1/checkout/transaction/"+t.data.reference+"/verify";var o={url:i,method:"GET",timeout:0,headers:{Authorization:"Bearer "+r}};setTimeout((()=>{e.ajax(o).done((function(t){var a=t.data.status;t.data.amount;document.getElementById("vellapaybutton").disabled=!1,e("#vellapaybutton").text("Pay Now"),"successful"===a.toLowerCase()||"completed"===a.toLowerCase()?(n.isPlaceOrderActionAllowed(!0),n.placeOrder()):(n.isPlaceOrderActionAllowed(!1),n.messageContainer.addErrorMessage({message:"awaiting payment confirmation"}))}))}),1e3)})),l.onError((t=>{n.isPlaceOrderActionAllowed(!1),n.messageContainer.addErrorMessage({message:"Error, Something went wrong"}),e("#vellapaybutton").text("Pay Now"),document.getElementById("vellapaybutton").disabled=!1})),l.onClose((()=>{n.messageContainer.addErrorMessage({message:"payment widget closed"}),e("#vellapaybutton").text("Pay Now"),document.getElementById("vellapaybutton").disabled=!1}))},afterPlaceOrder:function(){r.execute()}})}));